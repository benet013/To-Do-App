{% extends 'todoapp/base.html' %}
{% block content %}

<form method="POST" action="{% url 'todo-add' %}" class="d-flex align-items-center flex-nowrap mb-4">
    {% csrf_token %}
    <div data-mdb-input-init class="form-outline flex-fill me-2">
        <input type="text" name="content" id="form3" class="form-control form-control-lg" placeholder="Hi {{ user.username }}, what do you want to do today?"/>
    </div>
    <button type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-lg">Add</button>
</form>

<h6 class="mb-3">Todo List</h6>

<ul class="list-group mb-0" id="task-list">
    {% for task in taskList %}
    <li data-id="{{ task.id }}"
        class="list-group-item d-flex justify-content-between align-items-center border-start-0 border-top-0 border-end-0 border-bottom rounded-0 mb-2">
        <form action="{% url 'todo-delete' task.id %}" method="POST">
            {% csrf_token %}
            <div class="d-flex align-items-center">
                <input class="form-check-input me-2" type="checkbox" onclick="this.form.submit();" aria-label="..." />
                {{ task.content }}
            </div>
        </form>
    </li>
    {% endfor %}
</ul>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const taskList = document.getElementById('task-list');

    new Sortable(taskList, {
        animation: 150,
        onEnd: function (evt) {
            const ids = [...taskList.children].map(el => el.dataset.id);

            fetch("{% url 'update-task-order' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ ids })
            })
        }
    });
</script>

{% endblock %}